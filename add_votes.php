<?php
require 'auth.php';
$pageTitle = "إدخال الأصوات";
require 'config.php';
$message = "";
include 'header.php';
?>
<div class="card shadow-sm">
  <div class="card-body">
      <h2 class="card-title text-center mb-3">إدخال الأصوات</h2>
          <!-- حقل البحث عن المركز -->
              <div class="mb-3">
                    <input type="text" id="searchCenter" class="form-control" placeholder="ابحث عن مركز...">
                        </div>

                            <!-- قائمة المراكز -->
                                <div id="centersList" class="list-group mb-3">
                                      <?php
                                            // عرض المراكز مع تلوين زر المركز
                                                  $centersStmt = $pdo->query("SELECT * FROM centers ORDER BY center_name");
                                                        $centersList = $centersStmt->fetchAll();
                                                              $totalCandidates = $pdo->query("SELECT COUNT(*) FROM candidates")->fetchColumn();
                                                                    foreach ($centersList as $center):
                                                                              $centerId = $center['id'];
                                                                                        $totalStationsStmt = $pdo->prepare("SELECT COUNT(*) FROM stations WHERE center_id = ?");
                                                                                                  $totalStationsStmt->execute([$centerId]);
                                                                                                            $totalStations = $totalStationsStmt->fetchColumn();
                                                                                                                        
                                                                                                                                  $completeStations = 0;
                                                                                                                                            $stationsStmt = $pdo->prepare("SELECT id FROM stations WHERE center_id = ?");
                                                                                                                                                      $stationsStmt->execute([$centerId]);
                                                                                                                                                                while ($station = $stationsStmt->fetch()) {
                                                                                                                                                                              $voteCountStmt = $pdo->prepare("SELECT COUNT(*) FROM votes WHERE center_id = ? AND station_id = ?");
                                                                                                                                                                                            $voteCountStmt->execute([$centerId, $station['id']]);
                                                                                                                                                                                                          $enteredVotes = $voteCountStmt->fetchColumn();
                                                                                                                                                                                                                        if ($enteredVotes == $totalCandidates && $totalCandidates > 0) {
                                                                                                                                                                                                                                          $completeStations++;
                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                            $centerButtonClass = ($totalStations > 0 && $completeStations == $totalStations)
                                                                                                                                                                                                                                                                                                           ? "list-group-item-primary"
                                                                                                                                                                                                                                                                                                                                          : "list-group-item-secondary";
                                                                                                                                                                                                                                                                                                                                                ?>
                                                                                                                                                                                                                                                                                                                                                        <button type="button" class="list-group-item <?php echo $centerButtonClass; ?> list-group-item-action"
                                                                                                                                                                                                                                                                                                                                                                        onclick="selectCenter(<?php echo $centerId; ?>, '<?php echo addslashes($center['center_name']); ?>')">
                                                                                                                                                                                                                                                                                                                                                                                  <?php echo htmlspecialchars($center['center_name']); ?>
                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                        <!-- زر العودة إلى قائمة المراكز -->
                                                                                                                                                                                                                                                                                                                                                                                                            <div id="backToCenters" class="mb-3" style="display:none;">
                                                                                                                                                                                                                                                                                                                                                                                                                  <button type="button" class="btn btn-outline-primary btn-custom" onclick="showCentersList()">العودة إلى المراكز</button>
                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                          <!-- منطقة عرض المحطات بعد اختيار المركز -->
                                                                                                                                                                                                                                                                                                                                                                                                                              <div id="stationsArea" class="mb-3" style="display:none;">
                                                                                                                                                                                                                                                                                                                                                                                                                                    <h5 id="selectedCenterName"></h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                          <div id="stationsList" class="list-group"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                  <!-- منطقة عرض المرشحين بعد اختيار المحطة -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div id="candidatesArea" class="mb-3" style="display:none;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                            <h5 id="selectedStationName"></h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div id="candidatesList" class="list-group"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <!-- نموذج إدخال الأصوات بعد اختيار المرشح -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div id="voteFormArea" style="display:none;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <form id="voteForm" method="POST">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="hidden" name="center_id" id="form_center_id">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="hidden" name="station_id" id="form_station_id">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="hidden" name="candidate_id" id="form_candidate_id">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="mb-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <label class="form-label">عدد الأصوات</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <input type="number" name="vote_count" id="vote_count" class="form-control" min="0" required>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="d-grid gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button type="submit" class="btn btn-success btn-custom">حفظ الأصوات</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button type="button" class="btn btn-secondary btn-custom" onclick="resetForm()">إلغاء</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <!-- Toast Container -->
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div id="voteToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="display:none;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="d-flex">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="toast-body" id="toastBody">تم حفظ الأصوات</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // البحث في قائمة المراكز
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('searchCenter').addEventListener('keyup', function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let filter = this.value.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let centers = document.querySelectorAll('#centersList button');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        centers.forEach(button => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let txt = button.textContent.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    button.style.display = txt.includes(filter) ? 'block' : 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function selectCenter(centerId, centerName) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('form_center_id').value = centerId;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('selectedCenterName').textContent = "المحطات في " + centerName;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('centersList').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('backToCenters').style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('stationsArea').style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('candidatesArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('voteFormArea').style.display = "none";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let xhr = new XMLHttpRequest();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                xhr.open('GET', 'get_stations.php?center_id=' + centerId, true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    xhr.onload = function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (xhr.status === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  document.getElementById('stationsList').innerHTML = xhr.responseText;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                xhr.send();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function showCentersList() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('centersList').style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('backToCenters').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('stationsArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('candidatesArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('voteFormArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function selectStation(stationId, stationName) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('form_station_id').value = stationId;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('selectedStationName').textContent = "اختر مرشح من المحطة " + stationName;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('candidatesArea').style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('voteFormArea').style.display = "none";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let xhr = new XMLHttpRequest();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    xhr.open('GET', 'get_candidates.php?center_id=' + document.getElementById('form_center_id').value + '&station_id=' + stationId, true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        xhr.onload = function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (xhr.status === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      document.getElementById('candidatesList').innerHTML = xhr.responseText;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    xhr.send();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function selectCandidate(candidateId, candidateName, voteCount) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('form_candidate_id').value = candidateId;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('vote_count').value = voteCount;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('voteFormArea').style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('voteForm').addEventListener('submit', function(e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            e.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let formData = new FormData(this);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let xhr = new XMLHttpRequest();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        xhr.open('POST', 'save_vote.php', true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            xhr.onload = function(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (xhr.status === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          let response = JSON.parse(xhr.responseText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  showToast(response.message, response.status);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          loadCandidates(document.getElementById('form_center_id').value, document.getElementById('form_station_id').value);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        showToast("حدث خطأ أثناء حفظ الأصوات", "error");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      xhr.send(formData);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function loadCandidates(centerId, stationId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              let xhr = new XMLHttpRequest();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  xhr.open('GET', 'get_candidates.php?center_id=' + centerId + '&station_id=' + stationId, true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      xhr.onload = function() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (xhr.status === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById('candidatesList').innerHTML = xhr.responseText;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  xhr.send();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function resetForm() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          document.getElementById('voteFormArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              document.getElementById('candidatesArea').style.display = "none";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // دالة لإظهار Toast
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function showToast(message, status) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let toastElement = document.getElementById('voteToast');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let toastBody = document.getElementById('toastBody');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (status === "success") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      toastElement.className = "toast align-items-center text-bg-success border-0";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                toastElement.className = "toast align-items-center text-bg-danger border-0";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        toastBody.textContent = message;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let toast = new bootstrap.Toast(toastElement, { delay: 3000 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                toastElement.style.display = "block";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    toast.show();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <?php include 'footer.php'; ?>